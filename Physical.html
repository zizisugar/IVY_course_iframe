<!DOCTYPE html>
<html>
    <head>
        <style>
            body {
                margin: 0;
                font-family: 'Zen Antique Soft';
            }

            /* font-size
                vw => $px / 1440 * 100
                2.77vw = 40 / 1440 * 100

                there are 5 types of font-size.x
            */

            #subject-title {
                font-size: 2.77vw;
                font-weight: 900;
                width: 21.74vw;
                height: 6.46vw;
                padding-top: 7.29vw;
                margin-top: 0;
                margin-left: 6.59vw;
                margin-bottom: 0.003vw;
                text-align: center;
                justify-content: center;
                display: block;
            }

            #grade-section {
                display: flex;
                flex-direction: row;
                flex-wrap: nowrap;
                align-self: center;
                justify-content: space-between;
                /* width: 79.32vw; */
                min-height: 50vw;
                margin-left: 7.5%;
                margin-right: 7.5%;
                margin-bottom: 6.25vw;
            }

            .chapter-list {
                text-align: center;
                display: flex;
                flex-direction: column;
                width: 30%;
                align-items: center;
                margin-top: 1.1vw;
                margin-bottom: 2.36vw;
            }

            .chapter-list p {
                line-height: 4.861vw;
                /* width: 11.39vw; */
                height: 4.861vw;
                font-size: 2.5vw;
                font-weight: 900;
                margin-top: 0.1vw;
                margin-bottom: 0.868vw;
            }

            .chapter-list a {
                width: 100%;
                /* height: 4.027vw; */
                line-height: 4.027vw;
                word-break: break-all; 
                /* text-align: left;  */
                font-size: 2.22vw;
                font-style: normal;
                font-weight: 900;
                margin: 0.59vw;
                margin-bottom: 0.59vw;
                margin-left: 0;
                margin-right: 0;
            }

            #content-section {
                font-family: 'Zen Antique';
                width: 100%;
                display: none;
            }

            a {
                text-decoration: none;
                color: black;
            }

            a:hover {
                color: #00A490;
            }

            #content-title {
                display: flex;
                justify-content: space-between;
                flex-direction: row;
                align-items: center;
            }

            #concept-title {
                display: block;
                font-size: 2.5vw;
                font-weight: 600;
                text-align: left;
                /* width: 33.06vw; */
                height: 7.09vw;
                line-height: 7.09vw;
                margin-left: 6.67vw;
                margin-top: 0;
                margin-bottom: 0%;
            }

            #return-button {
                display: none;
                font-size: 1.11vw;
                color: #6f6f6f;
                margin-top: 2%;
                margin-left: 80%;
                position: fixed;
            }

            #return-button:hover {
                color: #00A490;
            }

            #return-button.scrolling {
                display: flex;
            }


            #content-outline-of-concept {
                width: 100%;
                background-color: rgb(0, 164, 144, 0.13);
                padding-top: 1vw;
                padding-bottom: 1vw;
            }

            #content-outline-of-concept a {
                padding-top: 0;
                padding-bottom: 0;
            }

            .content-outline-list {
                margin: 0%;
                font-weight: 400;
                font-size: 1.6vw;
                padding-top: 1vw;
                padding-bottom: 1vw;
                margin-left: 8.62vw;
                text-align: left;
                display: block;
            }

            #video-head {
                font-size: 2.5vw;
                font-weight: 900;
                margin-top: 1vw;
                margin-bottom: 1vw;
                /* width: 60vw; */
                height: 7.08vw;
                padding-top: 3vw;
                text-wrap: pretty;
            }

            #content-outline-of-animation {
                width: 100%;
                background-color: rgb(0, 173, 152, 0.4);
            }

            #content-outline-of-exercise {
                width: 100%;
                background-color: rgb(0, 137, 121, 0.4);
            }

            #content-outline-section {
                margin-bottom: 7.64vw;
            }

            #video-section {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                /* min-height: 80vh; */
            }

            .conceptvideo {
                width: 66.875vw;
                height: 39.79vw;
                margin-top: 3vw;
                margin-bottom: 7.57vw;
            }

            .exerciseform {
                width: 100%;
                height: 80vh;
                border: 0;
                /* margin-top: 5vw; */
                margin-bottom: 5vw;
            }

            #ani-section {
                display: flex;
                width: 100vw;
                flex-direction: column;
                text-align: center;
                align-items: center;
                margin-bottom: 8vw;
            }

            #exe-section {
                display: flex;
                width: 100vw;
                flex-direction: column;
                text-align: center;
                align-items: center;
                min-height: 100vh;
                margin-bottom: 8vw;
            }

            #animation-section-head {
                font-size: 2.5vw;
                font-weight: 900;
                margin-top: 1vw;
                margin-bottom: 1vw;
            }

            #exercise-section-head {
                font-size: 2.5vw;
                font-weight: 900;
                margin-top: 0;
                margin-bottom: 1vw;
                text-align: center;
            }

            .ani-explain {
                width: 60vw;
                text-align: left;
                font-size: 1.45vw;
                font-weight: 900;
                margin: 0;
            }

            .ani-link-head {
                color: #00A490;
                width: 60vw;
                text-align: left;
                margin: 0;
                font-size: 1.45vw;
                font-weight: 900;
            }

            .ani-link {
                color: #00A490;
                width: 60vw;
                text-align: center;
                border: 0.3vw solid;
                font-size: 1.45vw;
                font-weight: 900;
                display: inline-block;
                word-wrap: break-word;
                padding: 1vw;
                margin-bottom: 5vw;
            }

        </style>
        <script type = "text/javascript">
            const SHEET_ID = '1WMHa5jhu4CU69_f17v31z-bYZ2i8ts5LNMocIhV29qM';
            const EDUCATION = '高中';
            const SUBJECT = '物理';

            const COL_HASH = {
                'example': 'A',
                '國高中': 'B',
                '年級': 'C',
                '課程名稱': 'D',
                '章節名稱': 'E',
                '觀念名稱': 'F',
                '觀念影片': 'G',
                '概念動畫': 'H',
                '動畫解釋': 'I',
                '練習題': 'J'
            };
            const GID_HASH = {
                '高中': {
                    '物理': '0',
                    '化學': '1931802034',
                    '數學': '663005280',
                    '地球科學': '2068702923',
                    '生物': '545766521'
                },
                '國中': {
                    '理化': '315328052'
                }
            }
            var urlBase = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID_HASH[EDUCATION][SUBJECT]}`;


            async function LoadData(targetData, grade, plusCondition = "") {
                //makeQuery
                const selection = `SELECT ${targetData}`;
                const baseCondition = ` WHERE ${COL_HASH['example']} != "EX" \
                    AND ${COL_HASH['國高中']} = "${EDUCATION}" AND ${COL_HASH['年級']} = "${grade}"  \
                    AND ${COL_HASH['課程名稱']} = "${SUBJECT}"`;
                const url = urlBase + `&tqx=out:csv&tq=${selection + baseCondition + plusCondition}`;

                // need try catch error handling (Resolve, reject)
                const dupArr = await fetch(url).then((response) => response.text()).then(arr => {
                    const cleanArr = arr.split('"').filter(n => n.match(`.`) && !n.match('\,')); // remove ',', ' ', '"'

                    // group by
                    const colNum = (targetData.split(',')).length;

                    if (colNum === 1) {
                        // dedup when only 1-D array
                        return cleanArr.filter((item, pos, self) => {
                            return self.indexOf(item) === pos;
                        });
                    }
                    else {
                        const groupArr = Array.from({ length: Math.ceil(cleanArr.length / colNum) }, () => []);
                        cleanArr.forEach((value, index, array) => {
                            const returnIdx = Math.floor(index / colNum);
                            groupArr[returnIdx].push(value);
                        });
                        return groupArr;
                    }

                }).catch(err => console.log("test Fetch ERR-", err));
                return dupArr;
            }

            async function CreateChapterList() {
                async function CreateDiv(grade) {
                    const chapterList = await LoadData(COL_HASH['章節名稱'], grade);

                    // buildChapterLink
                    const chapterLinks = chapterList.map(chapter => {
                        return ` <a href="javascript:void(0)" onclick="javascript:CreateChapterContent('${chapter}','${grade}',true);ScrollWindow('concept-title');return false;">${chapter}</a>`;
                    }).join("");
                    const chapterLinkList = ` <p>${EDUCATION[0]}${grade}</p>${chapterLinks}`;
                    return `<div class="chapter-list" id="${grade}">` + chapterLinkList + '</div>';
                }

                document.getElementById("subject-title").innerText = SUBJECT;
                const gradeSectionData = await Promise.all(['一', '二', '三'].map(grade => CreateDiv(grade)));
                document.getElementById("grade-section").innerHTML = gradeSectionData.join('');


            }

            async function CreateChapterContent(chapterName, grade, click = false) {
                document.getElementById("content-section").style.display = "block";
                document.getElementById("concept-title").innerText = "章節名稱：" + chapterName;

                //buildConceptSection
                let conceptList = await LoadData(COL_HASH['觀念名稱'], grade, ` AND ${COL_HASH['章節名稱']} = "${chapterName}"`);
                const firstConcept = (conceptList.length==0)? "": conceptList[0];
                const conceptLinks = conceptList.map(conceptName => {
                    return ` <a class="content-outline-list" href="javascript:void(0)" onclick="javascript:LoadVideo('${chapterName}','${conceptName}', '${grade}');ScrollWindow('video-head');return false;">${conceptName}</a>`;
                }).join("");
                
                document.getElementById("content-outline-of-concept").innerHTML = conceptLinks;
                LoadContent(chapterName, grade, firstConcept);


            }

            function LoadContent(chapterName, grade, defaultContent = None) { // wait for everything
                //buildVideoSection
                LoadVideo(chapterName, defaultContent, grade)

                //buildAnimationSection
                LoadAnimation(chapterName, grade)

                //buildExerciseSection
                LoadExercise(chapterName, grade)
            }

            async function LoadVideo(chapterName, conceptName, grade) {
                document.getElementById("video-section").innerHTML = '<p id = "video-head" >觀念影片 : ' + conceptName + '</p>';

                const videoURLList = await LoadData(COL_HASH['觀念影片'], grade, ` AND ${COL_HASH['章節名稱']} = "${chapterName}" AND ${COL_HASH['觀念名稱']} = "${conceptName}"`);

                const videoEmbedList = videoURLList.map(url => {
                    return ` <iframe class="conceptvideo"  src="https://www.youtube.com/embed/${url.match('(?:youtu.be/)(.{11})')[1]}"></iframe>`;
                }).join("");
                document.getElementById("video-section").innerHTML += videoEmbedList;

            }

            async function LoadAnimation(chapterName, grade) {
                document.getElementById("ani-section").innerHTML = '<p id = "animation-section-head">動畫操作</p>';
                let aniSectionData = "";
                await LoadData([COL_HASH['概念動畫'], COL_HASH['動畫解釋']].join(','), grade, ` AND ${COL_HASH['章節名稱']} = "${chapterName}"`).then(
                    (listArr) => {
                        listArr.forEach((eleArr) => {
                            let url, desc;
                            if (eleArr[0].startsWith("http")) {
                                url = eleArr[0];
                                desc = eleArr[1] === undefined ? "" : eleArr[1];
                            }
                            else {
                                url = "";
                                desc = eleArr[0];
                            }
                            aniSectionData += ` <p class="ani-explain">${desc}</p> <a class="ani-link" href="${url}">${url}</a>`;
                        });
                    });
                document.getElementById("ani-section").innerHTML += aniSectionData;

            }

            async function LoadExercise(chapterName, grade) {
                document.getElementById("exe-section").innerHTML = '<p id="exercise-section-head" >練習題</p>';

                const exerciseURLList = await LoadData(COL_HASH['練習題'], grade, ` AND ${COL_HASH['章節名稱']} = "${chapterName}"`);
                const exerciseList = exerciseURLList.map(url => {
                    return ` <iframe class="exerciseform" src="${'https://docs.google.com/forms/d/e/' + url.match("e\/(.+?)\/viewform")[1] + '/viewform?embedded=true'}"></iframe>`;
                }).join("");
                document.getElementById("exe-section").innerHTML += exerciseList;

            }

            function ScrollWindow(htmlTagID) {
                document.getElementById(htmlTagID).scrollIntoView({ block: "start", inline: "nearest", behavior: "smooth" })
            }
            
            document.addEventListener("DOMContentLoaded", CreateChapterList)

            window.addEventListener('scroll',CheckPosition,false);
            function CheckPosition()
            {
                var returnButtonSelector = document.querySelector("#return-button"); 
                // catalog = 0: page on the top, catalog < -100: going to content
                var catalogRange = document.getElementById("catalog-section").getBoundingClientRect().top
                // content = 0: content title, content < -10: content section
                var contentRange = document.getElementById("content-section").getBoundingClientRect().top
                // console.log(`catalogRange:${catalogRange}, contentRange:${contentRange}`)
                 if (contentRange < -10){ // slightly movement
                    returnButtonSelector.classList.add("scrolling");
                    returnButtonSelector.innerText = "^ return to chapter"
                    returnButtonSelector.onclick = function(){
                        ScrollWindow('concept-title')
                        return false;
                    }
                }
                // second else-if for get "return to chapter" first
                else if (catalogRange < -100) { // some space without button while being in catalog section
                    returnButtonSelector.classList.add("scrolling");
                    returnButtonSelector.innerText = "^ return to top"
                    returnButtonSelector.onclick = function(){
                        ScrollWindow('catalog-section')
                        return false;
                    }
                }
                else{
                    returnButtonSelector.classList.remove("scrolling");
                }
            }
        </script> 
    </head>
    <body>
        <div><a id="return-button" href="javascript:void(0)">∧ return to top</a></div>
        <div id="catalog-section">
            <p id="subject-title"></p>
            <div id="grade-section"></div>
        </div>
        <div id="content-section">
            <div id="content-title">
                <p id="concept-title">章節名稱:</p>
            </div>
            <div id="content-outline-section">
                <div id="content-outline-of-concept"></div>
                <div id="content-outline-of-animation"><a class="content-outline-list" href="javascript:void(0)"
                        onclick="javascript : ScrollWindow('animation-section-head') ; return false ;">動畫操作</a></div>
                <div id="content-outline-of-exercise"><a class="content-outline-list" href="javascript:void(0)"
                        onclick="javascript : ScrollWindow('exercise-section-head') ; return false ;">練習題</a></div>
            </div>
            <div id="video-section"></div>
            <div id="ani-section"></div>
            <div id="exe-section"></div>
        </div>
    </body>
</html>
