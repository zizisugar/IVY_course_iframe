<!DOCTYPE html>
<html>
    <head>
        <meta name=”viewport” content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick.css" integrity="sha512-wR4oNhLBHf7smjy0K4oqzdWumd+r5/+6QO/vDda76MW5iug4PT7v86FoEkySIJft3XA0Ae6axhIvHrqwm793Nw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick-theme.css" integrity="sha512-6lLUdeQ5uheMFbWm3CP271l14RsX1xtx+J5x2yeIDkkiBpeVTNhTqijME7GgRKKi6hCqovwCoBTlRBEC20M8Mg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-migrate/3.5.2/jquery-migrate.min.js" integrity="sha512-BzvgYEoHXuphX+g7B/laemJGYFdrq4fTKEo+B3PurSxstMZtwu28FHkPKXu6dSBCzbUWqz/rMv755nUwhjQypw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick.min.js" integrity="sha512-HGOnQO9+SP1V92SrtZfjqxxtLmVzqZpjFFekvzZVWoiASSQgSr4cw9Kqd2+l8Llp4Gm0G8GIFJ4ddwZilcdb8A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
      
        <style>
:root {
    /* == small device: smd == */
    --smd-size-ratio: 2;

    /* color */
    --main-bg-color: #313131; /* white #313131; */
    --main-font-color: #e3e2d6; /* black #e3e2d6; */
    --assign-color: #00A490;
    --section-order-first-color: rgb(0, 164, 144, 0.13) ; 
    --section-order-second-color: rgb(0, 173, 152, 0.4);
    --section-order-third-color: rgb(0, 137, 121, 0.4);

    /* font */
    --main-font-family: 'Zen Antique Soft';
    --subject-fz: 2.77vw;
    --title-fz: 2.5vw; 
    --list-fz: 2.08vw;
    --catalog-list-fz: 1.8vw;
    --content-detail-fz: 2vw;
    --pointer-fz: 1.8vw;

    /* font weight */
    --main-title-fw: 900;
    --sub-title-fw: 600;
    --list-fw: 600;


    /* space */
    --title-left-shift-sp: 6vw;
    --iframe-height-sp: 40vw;
    --section-bottom-sp: 7vw;
    --title-top-sp: 6vw;
    --catalog-list-padding-sp: 1vw;

    --content-list-padding-sp: 1vw;
}
body {
    margin: 0;
    font-family: var(--main-font-family);
    background-color: var(--main-bg-color); 
    color: var(--main-font-color);
}
a {
    text-decoration: none;
    color: var(--main-font-color); 
}

a:hover {
    color: var(--assign-color);
}

#return-button:hover {
    color: var(--assign-color);
}

#return-button.scrolling {
    display: flex;
}

@media only screen and (min-width: 768px) {

    #catalog-section {
        /* padding: var(--catalog-list-padding-sp); */
    }

    #subject-title {
        font-size: var(--subject-fz); 
        font-weight: var(--main-title-fw);
        margin-left: var(--title-left-shift-sp);
        margin-top: var(--section-bottom-sp);
        text-align: left;
    }

    #grade-section { /* cancel if mobile */
        display: flex;
        justify-content: space-between; 
        margin-bottom: var(--section-bottom-sp);
    }

    .grade-title {
        text-align: center;
        font-size: var(--title-fz);
        font-weight: var(--sub-title-fw);
    }   

    .chapter-list {/* cancel if mobile */
        display: flex;
        flex-direction: column;
        width: 30%;
    }


    .chapter-list a{
        text-align: center; 
        padding: var(--catalog-list-padding-sp);
        /* line-break: normal; */
        font-size: var(--list-fz);
        font-weight: var(--list-title-fw);
    }

    #content-section { 
        display: none; 
        flex-direction: column;
        text-align: center;
        margin-bottom: var(--section-bottom-sp);
    }

    #content-main-title {
        font-size: var(--title-fz); 
        font-weight: var(--sub-title-fw);
        text-align: left;
        margin-left: var(--title-left-shift-sp);
    }

    .content-sub-title {
        font-size: var(--title-fz);
        font-weight: var(--main-title-fw);
        text-align: center;
        text-wrap: pretty;
        margin-top: var(--title-top-sp);
    }

    #content-outline-section a {
        font-weight: var(--list-title-fw);
        font-size: var(--catalog-list-fz);
        padding: calc(var(--content-list-padding-sp)*0.4);
        margin-left: calc(var(--title-left-shift-sp)*1.45);
        text-align: left;
        display: block;
    }

    #content-outline-of-video {
        background-color: var(--section-order-first-color);
    }

    #content-outline-of-animation {
        background-color:var(--section-order-second-color); 
        padding-top: var(--content-list-padding-sp);
        padding-bottom: var(--content-list-padding-sp);
    }

    #content-outline-of-exercise {
        background-color: var(--section-order-third-color);
        padding-top: var(--content-list-padding-sp);
        padding-bottom: var(--content-list-padding-sp);
    }

    .iframe-pair {
        margin-top: calc(var(--title-top-sp)*0.7);
        display: flex;
        align-items: center;

    }

    .iframe-video {
        width: 60%;
        float:left;
        height: var(--iframe-height-sp);
    }

    .iframe-pdf {
        width: 39%;
        float:right;
        height: var(--iframe-height-sp);
    }

    #ani-section {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .ani-pair {
        width: 60%;
        font-size: var(--content-detail-fz); 
        text-align: center;
        display: flex;
        flex-direction: column;
        margin: 1vw;
    }

    .ani-explain {
        text-align: left;
        margin: 0;
        padding-bottom: 1vw;
    }

    .ani-link {
        color: var(--assign-color);
        text-align: center;
        border: 0.3vw solid;
        font-size: calc(var(--content-detail-fz)*0.7);
        padding: 1vw;
        display: inline-block;
        word-wrap: break-word;
    }

    .exercise-form {
        width: 100%;
        height: 80vh;
        border: 0;
    }

    #return-button {
        display: none;
        font-size: var(--pointer-fz); 
        color: #0ee3c3;
        margin-top: 1%;
        margin-left: 80%;
        position: fixed;
    }
}

/* =================== small device =================== */
@media only screen and (max-width: 768px) {

    /* #catalog-section {
        padding: var(--content-list-padding-sp);
    } */

    #subject-title {
        font-size: calc(var(--subject-fz)*var(--smd-size-ratio)); 
        font-weight: var(--main-title-fw);
        margin-top: var(--section-bottom-sp);
        text-align: center;
    }

    #grade-section { 
        margin-bottom: var(--section-bottom-sp); 
        width: 80%;
        margin-left: 10vw;
        text-align: center;
        align-items: center;
    }

    .grade-title {
        text-align: center;
        font-size: calc(var(--title-fz)*var(--smd-size-ratio)); 
        font-weight: var(--sub-title-fw);
    }   
    /* .slick-list{padding:0 0 0 0 !important;} */
    .chapter-list a{
        padding: calc(var(--catalog-list-padding-sp)*2);;
        text-align: center; 
        display: flex;
        flex-direction: column;
        font-size: calc(var(--list-fz)*var(--smd-size-ratio)); 
        font-weight: var(--list-title-fw);
    }

    #content-section { 
        display: none; 
        flex-direction: column;
        text-align: center;
        margin-bottom: var(--section-bottom-sp);
    }

    #content-main-title {
        font-size: calc(var(--title-fz)*var(--smd-size-ratio));  
        font-weight: var(--sub-title-fw);
        text-align: left;
        margin-left: var(--title-left-shift-sp);
    }

    .content-sub-title {
        font-size: calc(var(--title-fz)*var(--smd-size-ratio)); 
        font-weight: var(--main-title-fw);
        text-align: center;
        text-wrap: pretty;
        margin-top: var(--title-top-sp);
        width: 80%;
        display: inline-block;
    }

    #content-outline-section a {
        width: 80%;
        font-weight: var(--list-title-fw);
        font-size: calc(var(--catalog-list-fz)*var(--smd-size-ratio)); 
        padding: calc(var(--content-list-padding-sp)*0.8);
        margin-left: calc(var(--title-left-shift-sp)*1.45);
        text-align: left;
        display: block;
    }

    #content-outline-of-video {
        background-color: var(--section-order-first-color);
    }

    #content-outline-of-animation {
        background-color:var(--section-order-second-color); 
        padding-top: var(--content-list-padding-sp);
        padding-bottom: var(--content-list-padding-sp);
    }

    #content-outline-of-exercise {
        background-color: var(--section-order-third-color);
        padding-top: var(--content-list-padding-sp);
        padding-bottom: var(--content-list-padding-sp);
    }

    .iframe-pair {
        margin-top: calc(var(--title-top-sp));
        /* display: flex; */
        align-items: center;

    }

    .iframe-video {
        width: 80%;
        /* float:left; */
        height: calc(var(--iframe-height-sp)*1.5);
    }

    .iframe-pdf {
        width: 80%;
        /* float:right; */
        height: calc(var(--iframe-height-sp)*3);
    }

    #ani-section {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .ani-pair {
        width: 60%;
        font-size: calc(var(--content-detail-fz)*var(--smd-size-ratio));  
        text-align: center;
        display: flex;
        flex-direction: column;
        margin: 1vw;
        padding: calc(var(--content-list-padding-sp)*0.8);
    }

    .ani-explain {
        text-align: left;
        margin: 0;
        padding-bottom: 1vw;
    }

    .ani-link {
        color: var(--assign-color);
        text-align: center;
        border: 0.3vw solid;
        font-size: calc(var(--content-detail-fz)*var(--smd-size-ratio)*0.7);
        padding: 1vw;
        display: inline-block;
        word-wrap: break-word;
    }

    .exercise-form {
        width: 100%;
        height: 80vh;
        border: 0;
    }
    
    #return-button {
        display: none;
        font-size: calc(var(--pointer-fz)*var(--smd-size-ratio));  
        color: #0ee3c3;
        margin-top: 1%;
        margin-left: 80%;
        position: fixed;
    }


}
        </style>
        <script type = "text/javascript">
            const SHEET_ID = '1WMHa5jhu4CU69_f17v31z-bYZ2i8ts5LNMocIhV29qM';
            const EDUCATION = '高中';
            const SUBJECT = '測試';

            const COL_HASH = {
                'example': 'A',
                '國高中': 'B',
                '年級': 'C',
                '課程名稱': 'D',
                '章節名稱': 'E',
                '觀念名稱': 'F',
                '觀念影片': 'G',
                '影片筆記': 'H',
                '概念動畫': 'I',
                '動畫解釋': 'J',
                '練習題': 'K'
            };
            const GID_HASH = {
                '高中': {
                    '物理': '0',
                    '化學': '1931802034',
                    '數學': '663005280',
                    '地球科學': '2068702923',
                    '生物': '545766521',
                    '測試': '1287470721'
                },
                '國中': {
                    '理化': '315328052'
                }
            }
            var urlBase = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID_HASH[EDUCATION][SUBJECT]}`;

            async function LoadData(targetData, grade, plusCondition = "") {
                //makeQuery
                const selection = `SELECT ${targetData}`;
                const baseCondition = ` WHERE ${COL_HASH['example']} != "EX" \
                    AND ${COL_HASH['國高中']} = "${EDUCATION}" AND ${COL_HASH['年級']} = "${grade}"  \
                    AND ${COL_HASH['課程名稱']} = "${SUBJECT}"`;
                const url = urlBase + `&tqx=out:csv&tq=${selection + baseCondition + plusCondition}`;

                // need try catch error handling (Resolve, reject)
                const dupArr = await fetch(url).then((response) => response.text()).then(arr => {
                    const cleanArr = arr.split('"').filter(n => n.match(`.`) && !n.match('\,')); 

                    // group by
                    const colNum = (targetData.split(',')).length;

                    if (colNum === 1) {
                        // dedup when only 1-D array
                        return cleanArr.filter((item, pos, self) => {
                            return self.indexOf(item) === pos;
                        });
                    }
                    else {
                        const groupArr = Array.from({ length: Math.ceil(cleanArr.length / colNum) }, () => []);
                        cleanArr.forEach((value, index, array) => {
                            const returnIdx = Math.floor(index / colNum);
                            groupArr[returnIdx].push(value);
                        });
                        return groupArr;
                    }

                }).catch(err => console.log("test Fetch ERR-", err));
                return dupArr;
            }

            async function CreateChapterList() {
                async function CreateDiv(grade) {
                    const chapterList = await LoadData(COL_HASH['章節名稱'], grade);

                    // buildChapterLink
                    const chapterLinks = chapterList.map(chapter => {
                        return ` <a href="javascript:void(0)" onclick="javascript:CreateChapterContent('${chapter}','${grade}');ScrollWindow('content-main-title');return false;">${chapter}</a>`;
                    }).join("");
                    const chapterLinkList = ` <p class="grade-title">${EDUCATION[0]}${grade}</p>${chapterLinks}`;
                    return `<div class="chapter-list" id="${grade}">` + chapterLinkList + '</div>';
                }

                document.getElementById("subject-title").innerText = SUBJECT;
                const gradeSectionData = await Promise.all(['一', '二', '三'].map(grade => CreateDiv(grade)));
                document.getElementById("grade-section").innerHTML = gradeSectionData.join('');

                CheckVerticalPosition();

                /* for test */
                // CreateChapterContent("直線運動", "二")

            }

            async function CreateChapterContent(chapterName, grade) {
                document.getElementById("content-section").style.display = "block";
                document.getElementById("content-main-title").innerText = "章節名稱：" + chapterName;

                //buildConceptSection
                let conceptList = await LoadData(COL_HASH['觀念名稱'], grade, ` AND ${COL_HASH['章節名稱']} = "${chapterName}"`);
                const firstConcept = (conceptList.length==0)? "": conceptList[0];
                const conceptLinks = conceptList.map(conceptName => {
                    return ` <a href="javascript:void(0)" onclick="javascript:LoadVideo('${chapterName}','${conceptName}', '${grade}');ScrollWindow('video-title');return false;">${conceptName}</a>`;
                }).join("");
                
                document.getElementById("content-outline-of-video").innerHTML = conceptLinks;
                document.getElementById("content-outline-of-video").style.paddingTop = '1vw';
                document.getElementById("content-outline-of-video").style.paddingBottom = '1vw';

                LoadContent(chapterName, grade, firstConcept);


            }

            function LoadContent(chapterName, grade, defaultContent = None) { // wait for everything
                //buildVideoSection
                LoadVideo(chapterName, defaultContent, grade)

                //buildAnimationSection
                LoadAnimation(chapterName, grade)

                //buildExerciseSection
                LoadExercise(chapterName, grade)
            }

            async function LoadVideo(chapterName, conceptName, grade) {
                document.getElementById("video-section").innerHTML = '<p id = "video-title" class="content-sub-title" >觀念影片 : ' + conceptName + '</p>';

                let videoSectionData = "";
                await LoadData([COL_HASH['觀念影片'], COL_HASH['影片筆記']].join(','), grade, ` AND ${COL_HASH['章節名稱']} = "${chapterName}" AND ${COL_HASH['觀念名稱']} = "${conceptName}"`).then(
                    (listArr) => {
                        listArr.forEach((eleArr) => {
                            url = eleArr[0].match('(?:youtu.be/)(.{11})')[1]
                            note = eleArr[1] === undefined ? "1mpyh78uTWz2tUtKAYMpomYLaKLb-BonsWf44XhF9M4U" : eleArr[1].match('(?:document\/d\/)(.+)(?:\/)')[1]
                            videoSectionData += 
                                '<div class="iframe-pair">' 
                                + ` <iframe class="iframe-video"  src="https://www.youtube.com/embed/${url}"></iframe>`
                                + ` <iframe class="iframe-pdf" src="https://drive.google.com/file/d/${note}/preview" frameborder=0; margin=0;width=100%;>筆記載入中…</iframe>`
                                + '</div>'
                        });
                    });
                document.getElementById("video-section").innerHTML += videoSectionData;
            }

            async function LoadAnimation(chapterName, grade) {
                document.getElementById("ani-section").innerHTML = '<p id="ani-title" class="content-sub-title">動畫操作</p>';
                let aniSectionData = "";
                await LoadData([COL_HASH['概念動畫'], COL_HASH['動畫解釋']].join(','), grade, ` AND ${COL_HASH['章節名稱']} = "${chapterName}"`).then(
                    (listArr) => {
                        listArr.forEach((eleArr) => {
                            let url, desc;
                            if (eleArr[0].startsWith("http")) {
                                url = eleArr[0];
                                desc = eleArr[1] === undefined ? "" : eleArr[1];
                            }
                            else {
                                url = "";
                                desc = eleArr[0];
                            }
                            aniSectionData += ` <div class="ani-pair"><p class="ani-explain">${desc}</p> <a class="ani-link" href="${url}">${url}</a></div>`;
                        });
                    });
                document.getElementById("ani-section").innerHTML += aniSectionData;

            }

            async function LoadExercise(chapterName, grade) {
                document.getElementById("exe-section").innerHTML = '<p id="exe-title" class="content-sub-title">練習題</p>';

                const exerciseURLList = await LoadData(COL_HASH['練習題'], grade, ` AND ${COL_HASH['章節名稱']} = "${chapterName}"`);
                const exerciseList = exerciseURLList.map(url => {
                    return ` <iframe class="exercise-form" src="${'https://docs.google.com/forms/d/e/' + url.match("e\/(.+?)\/viewform")[1] + '/viewform?embedded=true'}"></iframe>`;
                }).join("");
                document.getElementById("exe-section").innerHTML += exerciseList;

            }

            function ScrollWindow(htmlTagID) {
                document.getElementById(htmlTagID).scrollIntoView({ block: "start", inline: "nearest", behavior: "smooth" })
            }
            

            const settings = {
                dots: true,
                arrows:true,
                infinite: true,
                speed: 300,
                slidesToShow: 1
            }
            function CheckVerticalPosition(){
                if ($(window).width() >= 768) {
                    if ($('#grade-section').hasClass('slick-initialized')) {
                        $('#grade-section').slick('unslick');
                    }
                }else{
                    // reslick only if it's not slick()
                    if (!$('#grade-section').hasClass('slick-initialized')) {
                        $('#grade-section').slick(settings);
                    }
                }
            }

            function CheckHorizontalPosition()
            {
                var returnButtonSelector = document.querySelector("#return-button"); 
                var catalogRange = document.getElementById("catalog-section").getBoundingClientRect().top
                var contentRange = document.getElementById("content-section").getBoundingClientRect().top
                // console.log(`catalogRange:${catalogRange}, contentRange:${contentRange}`)
                 if (contentRange < -10){ // slightly movement
                    returnButtonSelector.classList.add("scrolling");
                    returnButtonSelector.innerText = "↑選擇觀念" //"^ return to chapter"
                    returnButtonSelector.onclick = function(){
                        ScrollWindow('content-main-title')
                        return false;
                    }
                }
                // second else-if for get "return to chapter" first
                else if (catalogRange < -100) { // some space without button while being in catalog section
                    returnButtonSelector.classList.add("scrolling");
                    returnButtonSelector.innerText = "↑選擇章節" //"^ return to top"
                    returnButtonSelector.onclick = function(){
                        ScrollWindow('catalog-section')
                        return false;
                    }
                }
                else{
                    returnButtonSelector.classList.remove("scrolling");
                }
            }
            window.addEventListener("DOMContentLoaded", CreateChapterList)
            window.addEventListener('resize', CheckVerticalPosition, false);
            window.addEventListener('scroll',CheckHorizontalPosition,false);

        </script> 
    </head>
    <body>
        <div><a id="return-button" href="javascript:void(0)">∧ return to top</a></div>
        <div id="catalog-section">
            <p id="subject-title"></p>
            <div id="grade-section"></div>
        </div>
        <div id="content-section">
            <p id="content-main-title">章節名稱:</p>
            <div id="content-outline-section">
                <div id="content-outline-of-video"></div>
                <div id="content-outline-of-animation"><a class="content-outline-list" href="javascript:void(0)"
                        onclick="javascript : ScrollWindow('ani-title') ; return false ;">動畫操作</a></div>
                <div id="content-outline-of-exercise"><a class="content-outline-list" href="javascript:void(0)"
                        onclick="javascript : ScrollWindow('exe-title') ; return false ;">練習題</a></div>
            </div>
            <div id="video-section"></div>
            <div id="ani-section"></div>
            <div id="exe-section"></div>
        </div>
    </body>
</html>
